<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI运势测算</title>
  <meta name="description" content="一个最简的网页项目">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 40px; line-height: 1.6; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-top: 0; }
    .hint { color: #666; }
    a { color: #0b5fff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .field { display: flex; flex-direction: column; gap: 6px; flex: 1 1 220px; }
    label { font-weight: 600; }
    input[type="text"], input[type="date"] { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    button { padding: 10px 16px; border: none; border-radius: 8px; background: #0b5fff; color: #fff; font-weight: 600; cursor: pointer; }
    button:disabled { background: #93c5fd; cursor: not-allowed; }
    .result { margin-top: 16px; padding: 16px; border-radius: 10px; background: #f8fafc; border: 1px solid #e2e8f0; }
    .score { font-size: 28px; font-weight: 800; }
  </style>
  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const nameInput = document.getElementById('name');
      const birthInput = document.getElementById('birth');
      const calcBtn = document.getElementById('calc');
      const resultBox = document.getElementById('result');
      const dsBtn = document.getElementById('ds');
      const dsResult = document.getElementById('ds-result');

      function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = (hash * 31 + str.charCodeAt(i)) >>> 0;
        }
        return hash;
      }

      function computeFortuneScore(name, birth) {
        const key = `${name}|${birth}`;
        const h = hashString(key);
        return h % 101;
      }

      function pick(arr, seed) {
        return arr[seed % arr.length];
      }

      function buildReading(score, seed) {
        const aspects = ['事业','财运','感情','健康','学业','人际','创造力','专注力'];
        const advice = [
          '把握当下的小机会，积少成多。',
          '与其纠结完美，不如先行动再优化。',
          '适度表达需求，善用他人资源。',
          '规律作息与轻运动将带来正反馈。',
          '今天适合做计划与复盘。',
          '避免情绪化决策，先喝口水再决定。',
          '大胆尝试新方法，灵感来自行动。',
          '给自己一个明确的截止时间。'
        ];
        const aspect = pick(aspects, seed);
        const tip = pick(advice, seed >> 3);
        let tier = '中等';
        if (score >= 80) tier = '极佳';
        else if (score >= 60) tier = '良好';
        else if (score >= 40) tier = '平稳';
        else if (score >= 20) tier = '偏弱';
        else tier = '需谨慎';
        return { aspect, tip, tier };
      }

      function render() {
        const name = (nameInput.value || '').trim();
        const birth = birthInput.value || '';
        if (!name || !birth) {
          resultBox.innerHTML = '<span class="hint">请输入姓名并选择生日后点击计算。</span>';
          calcBtn.disabled = true;
          if (dsBtn) dsBtn.disabled = true;
          return;
        }
        calcBtn.disabled = false;
        if (dsBtn) dsBtn.disabled = false;
      }

      async function onCalc() {
        const name = nameInput.value.trim();
        const birth = birthInput.value;
        const prompt = `请你作为命理大师，为姓名是${name}、出生在${birth}的用户生成一段有趣的今日运势解读，要求语言轻松神秘，包含幸运数字和建议。`;

        resultBox.innerHTML = `
          <div>
            <div style="font-weight:600;">AI 运势解读（流式输出）</div>
            <pre id="ai-result" style="white-space:pre-wrap; margin:8px 0 0 0;"></pre>
          </div>
        `;
        const aiResult = document.getElementById('ai-result');

        const messages = [
          { role: 'user', content: prompt }
        ];

        calcBtn.disabled = true;
        try {
          await streamDeepSeek(messages, delta => { aiResult.textContent += delta; });
        } catch (e) {
          aiResult.textContent = `请求失败：${e.message || e}`;
        } finally {
          calcBtn.disabled = false;
        }
      }

      nameInput.addEventListener('input', render);
      birthInput.addEventListener('input', render);
      calcBtn.addEventListener('click', onCalc);
      
      async function streamDeepSeek(messages, onDelta) {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });
        if (!resp.ok || !resp.body) {
          const errText = await resp.text().catch(() => '请求失败');
          throw new Error(errText || `HTTP ${resp.status}`);
        }
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const payload = line.slice(6).trim();
            if (payload === '[DONE]') return;
            try {
              const json = JSON.parse(payload);
              const delta = json.choices?.[0]?.delta?.content ?? '';
              if (delta && typeof onDelta === 'function') onDelta(delta);
            } catch {}
          }
        }
      }

      async function onDeepSeek() {
        const name = nameInput.value.trim();
        const birth = birthInput.value;
        dsResult.textContent = '';
        const prompt = `请基于以下信息，用简洁中文给出今日运势建议（50-120字）：\n姓名：${name}\n生日：${birth}\n`;
        const messages = [
          { role: 'system', content: '你是一位温和且务实的运势顾问，给出具体可执行建议。' },
          { role: 'user', content: prompt }
        ];
        dsBtn.disabled = true;
        try {
          await streamDeepSeek(messages, delta => { dsResult.textContent += delta; });
        } catch (e) {
          dsResult.textContent = `请求失败：${e.message || e}`;
        } finally {
          dsBtn.disabled = false;
        }
      }

      if (dsBtn) dsBtn.addEventListener('click', onDeepSeek);
      render();
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>AI运势测算</h1>
    <div class="card" style="margin-top:16px;">
      <div class="row">
        <div class="field">
          <label for="name">姓名</label>
          <input id="name" type="text" placeholder="请输入姓名" autocomplete="name" />
        </div>
        <div class="field">
          <label for="birth">生日</label>
          <input id="birth" type="date" />
        </div>
      </div>
      <div style="margin-top:16px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
        <button id="calc" disabled>计算今日运势</button>
        <button id="ds" disabled>用 DeepSeek 生成建议</button>
        <span class="hint">不存储任何输入；DeepSeek 由后端代理转发</span>
      </div>
      <div id="result" class="result" style="margin-top:16px;"></div>
      <div class="result" style="margin-top:12px;">
        <div style="font-weight:600; margin-bottom:6px;">DeepSeek 建议（流式输出）</div>
        <pre id="ds-result" style="white-space:pre-wrap; margin:0;"></pre>
      </div>
    </div>
  </div>
</body>
</html>


