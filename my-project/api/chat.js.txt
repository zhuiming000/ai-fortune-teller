// api/chat.js
// 此文件是Vercel Serverless Function（后端API）

export default async function handler(req, res) {
  // 1. 设置CORS头部，允许你的前端页面调用这个接口（解决跨域问题）
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  // 2. 处理浏览器的预检请求（OPTIONS）
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  // 3. 只允许POST请求
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method Not Allowed. Use POST.' });
  }

  try {
    // 4. 获取从前端发送过来的数据
    const { messages } = req.body;

    // 5. 调用DeepSeek API
    const deepseekResponse = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}` // 从环境变量安全读取API Key
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: messages,
        stream: true, // 开启流式传输
        temperature: 0.7 // 控制生成文本的随机性，可选
      })
    });

    // 6. 检查DeepSeek API的响应状态
    if (!deepseekResponse.ok) {
      const errorText = await deepseekResponse.text();
      console.error('DeepSeek API Error:', deepseekResponse.status, errorText);
      throw new Error(`DeepSeek API Error: ${deepseekResponse.status}`);
    }

    // 7. 设置响应头，准备流式传输
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');

    // 8. 创建流式读取器
    const reader = deepseekResponse.body.getReader();
    const decoder = new TextDecoder();

    // 9. 持续读取流数据并转发给前端
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      // 解码并转发数据块
      const chunk = decoder.decode(value);
      res.write(chunk);
    }

    // 10. 流式传输结束
    res.end();

  } catch (error) {
    // 11. 错误处理
    console.error('Server Error:', error);
    res.status(500).json({ 
      error: 'Internal Server Error',
      message: error.message 
    });
  }
}